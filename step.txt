G-LockON動作の流れ

1.
各変数の定義

2.
createDatagramSocket()を呼びソケットの作成

3.
スタートボタンを認識し、サーバのIP、Port番号等の登録、STUNServerClientクラスのstunServerClientStart()を呼ぶ

4.
STUNsenderを並列スレッドで実行

5.
sender内でreceverを起動する

6.
データを受け取り、受け取った情報をIP、Portに分ける

7.
mainのonGetGlobalIP_Port()
これの引数はSTUNサーバから返ってきたやつ
（６で分割したやつ）

8.
publicIP,publicPortは引数の情報を登録する
privateIPはmain内のGetPrivateIP()を使う
privatePortはDatagramSocketクラス（main内ではsocketというインスタンス）のメソッドを使い取得

P2P
9.
P2Pクラスのインスタンスの生成
コンストラクタ内でsetUpMemory()を呼び出し、CSVに出力するための設定を行う

10.
receiverの並列開始

11.
P2PReceiver内でプロセスタイプと同名の定数の定義をし、データを受け取る

12.
受け取ったデータをString型に変換し、識別子からプロセスタイプの情報を持ってくる

13.
プロセスタイプごとに次に行う処理を決定する



GET_PERIPHERAL_USER：
1.
getPerioheralUsers()で周りのユーザの情報をリストに登録する

2.
getPerioheralUsers()内では一人ずつUserInfo型のオブジェクトを作成し、一人ずつリストに登録していく
メソッド内にはperipheralUserとperipheralUsersがあるため注意
前者はUserInfo型のオブジェクト、後者はそれらをまとめたリスト

3.
onGetPerioheralUser()からonGetPeripheralUsersInfo()を呼び出し、arrangeMarker()を呼ぶ
このとき、第一引数はnullでメソッドを呼び出している

4.
最初のif文で現在登録されているマーカーリストと現在の周辺ユーザの比較を行う
マーカーリストに登録されているユーザーが現在の周辺ユーザーに入っていたらcontinueMarkerに追加、見つからなければremoveMarkerに追加する

5.
周辺に居るユーザの数が0のときはマーカーリストの内容をすべて削除し、0でないときはremoveMarkerの人だけ削除し、markerListにcontinueMarkerを上書きする→return

6.
P2PNatRegisterSenderのコンストラクタを呼び出し、自分のパブリクIP,Port、ソケット、周辺ユーザの情報、プロセスタイプを渡す
このときのプロセスタイプはNATRegisterDstUsersになっている

7.
 natRegisterDstUsers()を呼び出す
対象のユーザが自分と同一IP→同一NATに存在するためプライベートIP,Portでやり取りをする
対象のユーザが異なるIP→異なるNATに存在する端末の場合はパブリックIP、Portを使ってNAT通過
それぞれに意味のないメッセージを送る



DO_UDP_HOLE_PUNCHING：
1.
getSrcUser()で自身を検索したユーザのパブリック、プライベートIP,Portの登録を行い、登録したUserInfo型のオブジェクトをreturnする

2.
このユーザが周辺ユーザのリストに登録されているか確認し、されていない場合は新たに追加する



SEND_DATA
1.
P2PJSONObject型のコンストラクタを呼び出し、受け取ったJSONオブジェクトのいち情報を読み取る

2.
１で読み取った情報等をonGetPeripheralUserLocation()に渡す
＊parmはP2Pクラス内のドキュメント参照

3.
自分が保存している周辺ユーザの情報と比較し、通信相手の情報が登録されているか確認する
このときパブリック、プライベートの両方と比較する

4.
位置情報、peerID、スピードを上書きし、sendAck()を呼び出す

5.
SendAck型のコンストラクタを呼び出し、並列処理を開始する

6.
プロセスタイプをAckとしたJSONオブジェクトに受け取ったlocationCountを追加し、送信する


ACK
1.
受け取った情報をCSVで保存